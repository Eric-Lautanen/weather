<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>SimpleWeather</title>
    <style>
        :root{--bg-color:#ffffff;--text-color:#000000;--accent-color:#007bff;--card-bg:#f8f9fa;--shadow:0 4px 6px rgba(0,0,0,0.1);--overlay-bg:rgba(255,255,255,0.95)}
        body.dark{--bg-color:#121212;--text-color:#ffffff;--accent-color:#0d6efd;--card-bg:#1e1e1e;--shadow:0 4px 6px rgba(0,0,0,0.2);--overlay-bg:rgba(30,30,30,0.95)}
        *{box-sizing:border-box}
        body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background-color:var(--bg-color);color:var(--text-color);min-height:100vh;transition:background-color 0.3s,color 0.3s}
        
        /* Navigation & Toggles */
        .nav-btn{position:fixed;top:1rem;z-index:2000;background-color:var(--card-bg);border:none;cursor:pointer;font-size:1.5rem;transition:transform 0.3s;padding:0;border-radius:50%;box-shadow:var(--shadow);width:50px;height:50px;display:flex;align-items:center;justify-content:center;color:var(--text-color)}
        #theme-toggle{left:1rem}
        #menu-toggle{right:1rem;display:none} /* Hidden on desktop */
        
        .nav-btn:hover{transform:scale(1.1)}
        .nav-btn:active{transform:scale(0.95)}

        /* Layout */
        #main-container{width:100%;max-width:1400px;margin:0 auto;padding:1.5rem;padding-top:5rem;display:flex;gap:1.5rem;align-items:flex-start}
        
        /* Controls Panel (Left Side on Desktop, Drawer on Mobile) */
        #controls-panel{width:300px;flex-shrink:0;display:flex;flex-direction:column;gap:1rem;transition:transform 0.3s ease-in-out}
        
        /* Common Card Styles */
        .card{background-color:var(--card-bg);padding:1rem;border-radius:12px;box-shadow:var(--shadow)}
        
        /* Forms & Inputs */
        #zip-form{display:flex;gap:0.5rem;margin-bottom:1rem}
        #zip-input{flex:1;padding:0.75rem;border:1px solid #ccc;border-radius:8px;background-color:var(--bg-color);color:var(--text-color);font-size:16px;min-width:0} /* 16px prevents iOS zoom */
        #zip-input:focus{border-color:var(--accent-color);outline:none}
        
        button.action-btn{padding:0.5rem 1rem;background-color:var(--accent-color);color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.95rem;font-weight:600}
        button.action-btn:hover{filter:brightness(110%)}
        button.action-btn:disabled{opacity:0.5}

        /* Recent Zips */
        #recent-zips h3{margin:0 0 1rem 0;font-size:1.1rem}
        #recent-list{display:flex;flex-direction:column;gap:0.5rem;max-height:300px;overflow-y:auto}
        .recent-item{display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background-color:var(--bg-color);border-radius:8px;cursor:pointer}
        .recent-item:hover{background-color:var(--accent-color);color:white}
        .recent-info{flex:1}
        .recent-zip{font-weight:bold}
        .recent-city{font-size:0.8rem;opacity:0.8}
        .remove-btn{background:none;border:none;color:inherit;font-size:1.5rem;padding:0 0.5rem;opacity:0.5;cursor:pointer}
        .remove-btn:hover{opacity:1}

        /* Radar Selector */
        #radar-source-selector label.section-title{font-weight:600;display:block;margin-bottom:0.75rem}
        .radio-option{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;padding:0.5rem;border-radius:6px;cursor:pointer}
        .radio-option:hover{background-color:var(--bg-color)}

        /* Weather Display (Right Side) */
        #weather-container{flex:1;min-width:0;display:flex;flex-direction:column;gap:1.5rem}
        
        #map-wrapper{position:relative;width:100%}
        #map{height:50vh;min-height:350px;width:100%;border-radius:12px;box-shadow:var(--shadow);background-color:var(--card-bg);z-index:1}
        #radar-timestamp{position:absolute;bottom:10px;left:10px;background-color:rgba(0,0,0,0.7);color:white;padding:0.5rem 0.75rem;border-radius:6px;font-size:0.85rem;z-index:1000;pointer-events:none;backdrop-filter:blur(4px)}
        
        #current-weather{text-align:center;padding:2rem}
        #current-temp{font-size:3.5rem;font-weight:800;margin:0.5rem 0;letter-spacing:-1px}
        #current-desc{font-size:1.2rem;opacity:0.9;margin:0}
        
        #forecast{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem}
        .forecast-card{text-align:center;padding:1.5rem 1rem;transition:transform 0.2s}
        .forecast-card:hover{transform:translateY(-3px)}
        .forecast-card h3{margin:0 0 0.5rem 0;font-size:0.9rem;text-transform:uppercase;letter-spacing:0.5px;opacity:0.8}
        .forecast-card .temp{font-size:1.8rem;font-weight:bold;margin:0.5rem 0}
        
        .loading{text-align:center;padding:2rem;color:var(--accent-color)}
        .error{background-color:#ff4444;color:white;padding:1rem;border-radius:8px;margin-bottom:1rem;text-align:center}

        /* Mobile Optimization */
        @media (max-width: 900px) {
            #menu-toggle{display:flex} /* Show Hamburger */
            #main-container{flex-direction:column;padding:0;padding-top:0}
            
            /* The Drawer Menu */
            #controls-panel{
                position:fixed;
                top:0;
                right:0;
                height:100vh;
                width:85%;
                max-width:320px;
                background-color:var(--card-bg);
                z-index:3000;
                padding:5rem 1.5rem 2rem 1.5rem;
                box-shadow:-5px 0 15px rgba(0,0,0,0.3);
                transform:translateX(100%); /* Hidden by default */
                overflow-y:auto;
            }
            #controls-panel.open{transform:translateX(0)}
            
            /* Overlay when menu is open */
            #menu-overlay{
                position:fixed;top:0;left:0;width:100%;height:100%;
                background:rgba(0,0,0,0.5);z-index:2900;
                opacity:0;pointer-events:none;transition:opacity 0.3s;
                backdrop-filter:blur(2px);
            }
            #menu-overlay.open{opacity:1;pointer-events:all}

            /* Full Width Map & Content */
            #weather-container{width:100%;gap:0}
            #map{border-radius:0;height:60vh;border-bottom:1px solid rgba(0,0,0,0.1)}
            #current-weather{border-radius:0;box-shadow:none;border-bottom:1px solid rgba(0,0,0,0.05);padding:1.5rem}
            #forecast{padding:1rem;gap:0.75rem}
            .forecast-card{background-color:var(--bg-color);box-shadow:0 2px 4px rgba(0,0,0,0.05);border:1px solid rgba(0,0,0,0.05)}
            
            /* Theme Toggle adjustment */
            #theme-toggle{top:1rem;left:1rem;width:45px;height:45px;background:rgba(255,255,255,0.8);backdrop-filter:blur(4px)}
            body.dark #theme-toggle{background:rgba(30,30,30,0.8)}
            #menu-toggle{top:1rem;right:1rem;width:45px;height:45px;background:var(--accent-color);color:white}
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
    <div id="menu-overlay"></div>
    <button id="theme-toggle" class="nav-btn">ðŸŒ™</button>
    <button id="menu-toggle" class="nav-btn">â˜°</button>

    <div id="main-container">
        <div id="controls-panel">
            <div id="recent-zips" class="card">
                <form id="zip-form">
                    <input type="text" id="zip-input" placeholder="ZIP Code" maxlength="5" pattern="\d{5}" required>
                    <button type="submit" id="set-zip-btn" class="action-btn">Go</button>
                </form>
                <h3>Recent Locations</h3>
                <div id="recent-list"></div>
            </div>
            
            <div id="radar-source-selector" class="card">
                <label class="section-title">Radar Source</label>
                <div class="radio-options">
                    <label class="radio-option">
                        <input type="radio" id="radar-rainviewer" name="radar-source" value="rainviewer" checked>
                        <span>RainViewer</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="radar-noaa" name="radar-source" value="noaa">
                        <span>NOAA (Buggy)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="radar-openweather" name="radar-source" value="openweather">
                        <span>OpenWeather (Buggy)</span>
                    </label>
                </div>
            </div>
            <button id="close-menu-btn" class="action-btn" style="width:100%; margin-top:auto; display:none;">Close Menu</button>
        </div>

        <div id="weather-container">
            <div id="map-wrapper">
                <div id="map"></div>
                <div id="radar-timestamp">Loading radar...</div>
            </div>
            <div id="current-weather" class="card">
                <h2>Current Weather</h2>
                <p id="current-temp">--Â°F</p>
                <p id="current-desc">Loading...</p>
            </div>
            <div id="forecast"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        // --- UI & Menu Logic ---
        const menuToggle = document.getElementById('menu-toggle');
        const controlsPanel = document.getElementById('controls-panel');
        const overlay = document.getElementById('menu-overlay');
        const closeMenuBtn = document.getElementById('close-menu-btn');

        function toggleMenu(show) {
            if (show) {
                controlsPanel.classList.add('open');
                overlay.classList.add('open');
                menuToggle.textContent = 'âœ•';
                closeMenuBtn.style.display = 'block';
            } else {
                controlsPanel.classList.remove('open');
                overlay.classList.remove('open');
                menuToggle.textContent = 'â˜°';
                setTimeout(() => closeMenuBtn.style.display = 'none', 300);
            }
        }

        menuToggle.addEventListener('click', () => {
            const isOpen = controlsPanel.classList.contains('open');
            toggleMenu(!isOpen);
        });

        overlay.addEventListener('click', () => toggleMenu(false));
        closeMenuBtn.addEventListener('click', () => toggleMenu(false));

        // --- Weather Logic ---
        const state = {
            zip: '',
            isDark: false,
            map: null,
            radarLayers: [],
            currentRadarIndex: 0,
            radarInterval: null,
            radarTimes: [],
            recentZips: [],
            weatherRefreshInterval: null,
            radarSource: 'rainviewer'
        };

        function loadRecentZips() {
            const stored = localStorage.getItem('recentZips');
            if (stored) {
                try {
                    state.recentZips = JSON.parse(stored);
                } catch (e) { state.recentZips = []; }
            }
        }

        function saveRecentZips() {
            localStorage.setItem('recentZips', JSON.stringify(state.recentZips));
        }

        function addRecentZip(zip, city, stateName) {
            state.recentZips = state.recentZips.filter(item => item.zip !== zip);
            state.recentZips.unshift({ zip, city, state: stateName });
            if (state.recentZips.length > 10) state.recentZips = state.recentZips.slice(0, 10);
            saveRecentZips();
            renderRecentZips();
        }

        function removeRecentZip(zip) {
            state.recentZips = state.recentZips.filter(item => item.zip !== zip);
            saveRecentZips();
            renderRecentZips();
        }

        function renderRecentZips() {
            const list = document.getElementById('recent-list');
            list.innerHTML = '';
            
            if (state.recentZips.length === 0) {
                list.innerHTML = '<p style="opacity: 0.6; font-size: 0.9rem;">No recent locations</p>';
                return;
            }
            
            state.recentZips.forEach(item => {
                const div = document.createElement('div');
                div.className = 'recent-item';
                div.innerHTML = `
                    <div class="recent-info">
                        <div class="recent-zip">${item.zip}</div>
                        <div class="recent-city">${item.city}, ${item.state}</div>
                    </div>
                    <button class="remove-btn" data-zip="${item.zip}">Ã—</button>
                `;
                
                div.querySelector('.recent-info').addEventListener('click', () => {
                    state.zip = item.zip;
                    localStorage.setItem('zip', state.zip);
                    document.getElementById('zip-input').value = state.zip;
                    toggleMenu(false); // Close menu on mobile when clicking recent
                    loadWeather();
                });
                
                div.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeRecentZip(item.zip);
                });
                
                list.appendChild(div);
            });
        }

        // Theme Handling
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('theme');
        state.isDark = savedTheme === 'dark';
        document.body.classList.toggle('dark', state.isDark);
        themeToggle.textContent = state.isDark ? 'â˜€ï¸' : 'ðŸŒ™';

        themeToggle.addEventListener('click', () => {
            state.isDark = !state.isDark;
            document.body.classList.toggle('dark', state.isDark);
            themeToggle.textContent = state.isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
            updateMapTheme();
        });

        // Radar Source Handling
        const savedRadarSource = localStorage.getItem('radarSource');
        if (savedRadarSource) {
            state.radarSource = savedRadarSource;
            const savedRadio = document.getElementById(`radar-${savedRadarSource}`);
            if (savedRadio) savedRadio.checked = true;
        }

        document.querySelectorAll('input[name="radar-source"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.radarSource = e.target.value;
                localStorage.setItem('radarSource', state.radarSource);
                if (state.map) loadAnimatedRadar();
            });
        });

        // ZIP Handling
        loadRecentZips();
        state.zip = localStorage.getItem('zip') || '49855';
        document.getElementById('zip-input').value = state.zip;

        const zipForm = document.getElementById('zip-form');
        const setZipBtn = document.getElementById('set-zip-btn');

        zipForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newZip = document.getElementById('zip-input').value.trim();
            if (newZip.length === 5 && /^\d+$/.test(newZip)) {
                state.zip = newZip;
                localStorage.setItem('zip', state.zip);
                toggleMenu(false); // Close menu on submit
                loadWeather();
            } else {
                showError('Please enter a valid 5-digit ZIP code.');
            }
        });

        function showError(message) {
            const container = document.getElementById('weather-container');
            // Remove existing error if any
            const existingError = document.querySelector('.error');
            if (existingError) existingError.remove();

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // Insert after map
            const mapWrapper = document.getElementById('map-wrapper');
            container.insertBefore(errorDiv, mapWrapper.nextSibling);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showLoading(show) {
            setZipBtn.disabled = show;
            setZipBtn.textContent = show ? '...' : 'Go';
        }

        // API Functions
        async function getLocationFromZip(zip) {
            const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
            if (!res.ok) throw new Error('Invalid ZIP code');
            const data = await res.json();
            const place = data.places[0];
            return {
                lat: parseFloat(place.latitude),
                lon: parseFloat(place.longitude),
                city: place['place name'],
                state: place.state
            };
        }

        async function fetchWeather(lat, lon) {
            const pointRes = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
            if (!pointRes.ok) throw new Error('Unable to fetch weather data');
            const pointData = await pointRes.json();
            const forecastUrl = pointData.properties.forecast;

            const forecastRes = await fetch(forecastUrl, { headers: { 'User-Agent': 'QuickWeatherPWA/1.0' } });
            if (!forecastRes.ok) throw new Error('Unable to fetch forecast');
            const forecastData = await forecastRes.json();
            return forecastData.properties.periods;
        }

        async function loadWeather() {
            showLoading(true);
            try {
                const { lat, lon, city, state: stateName } = await getLocationFromZip(state.zip);
                addRecentZip(state.zip, city, stateName);

                const periods = await fetchWeather(lat, lon);
                const current = periods[0];
                
                document.getElementById('current-temp').textContent = `${current.temperature}Â°${current.temperatureUnit}`;
                document.getElementById('current-desc').textContent = current.shortForecast;

                const forecastDiv = document.getElementById('forecast');
                forecastDiv.innerHTML = '';
                periods.slice(1, 7).forEach(period => {
                    const card = document.createElement('div');
                    card.className = 'forecast-card card';
                    card.innerHTML = `
                        <h3>${period.name}</h3>
                        <div class="temp">${period.temperature}Â°${period.temperatureUnit}</div>
                        <p style="font-size: 0.9rem; margin:0">${period.shortForecast}</p>
                    `;
                    forecastDiv.appendChild(card);
                });

                loadMap(lat, lon);
                
                if (state.weatherRefreshInterval) clearInterval(state.weatherRefreshInterval);
                state.weatherRefreshInterval = setInterval(loadWeather, 10 * 60 * 1000);
            } catch (err) {
                console.error('Weather error:', err);
                showError('Error loading data. Check ZIP or connection.');
            } finally {
                showLoading(false);
            }
        }

        // Map Functions
        let baseLayer;
        function loadMap(lat, lon) {
            if (state.map) {
                state.map.setView([lat, lon], 10);
                loadAnimatedRadar();
                return;
            }

            // Move zoom control to bottom right so it doesn't conflict with hamburger
            state.map = L.map('map', { zoomControl: false }).setView([lat, lon], 10);
            L.control.zoom({ position: 'bottomright' }).addTo(state.map);
            
            const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
            
            baseLayer = state.isDark ? darkLayer : lightLayer;
            baseLayer.addTo(state.map);

            loadAnimatedRadar();
        }
        
        function updateMapTheme() {
            if (!state.map) return;
            state.map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer && !state.radarLayers.includes(layer)) {
                    state.map.removeLayer(layer);
                }
            });
            const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
            baseLayer = state.isDark ? darkLayer : lightLayer;
            baseLayer.addTo(state.map);
        }

        function updateRadarTimestamp() {
            if (state.radarTimes.length === 0) return;
            const currentTime = state.radarTimes[state.currentRadarIndex];
            const date = new Date(currentTime * 1000);
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            document.getElementById('radar-timestamp').textContent = `Radar: ${timeStr}`;
        }

        async function loadAnimatedRadar() {
            // Note: Currently only RainViewer is implemented correctly.
            // NOAA and OpenWeather options are place holders in the UI as per request.
            
            state.radarLayers.forEach(layer => {
                if (state.map.hasLayer(layer)) state.map.removeLayer(layer);
            });
            state.radarLayers = [];
            state.radarTimes = [];
            if (state.radarInterval) {
                clearInterval(state.radarInterval);
                state.radarInterval = null;
            }
            
            try {
                const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                if (!res.ok) throw new Error('Failed to fetch radar');
                const data = await res.json();
                
                const frames = data.radar.past.slice(-10).concat(data.radar.nowcast.slice(0, 2));
                
                // Color scheme based on current temp (Rain vs Snow)
                const currentTempText = document.getElementById('current-temp').textContent;
                const tempMatch = currentTempText.match(/(-?\d+)/);
                const temp = tempMatch ? parseInt(tempMatch[0]) : 50;
                let colorScheme = 1; // Rain
                if (temp <= 32) colorScheme = 2; // Snow
                else if (temp <= 36) colorScheme = 4; // Mix
                
                frames.forEach((frame, idx) => {
                    state.radarTimes.push(frame.time);
                    const layer = L.tileLayer(
                        `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/${colorScheme}/1_1.png`, 
                        {
                            transparent: true, opacity: 0, zIndex: 1000 + idx,
                            tileSize: 256, maxZoom: 18, minZoom: 0
                        }
                    );
                    layer.addTo(state.map);
                    state.radarLayers.push(layer);
                });

                if (state.radarLayers.length > 0) {
                    state.radarLayers[0].setOpacity(0.7);
                    state.currentRadarIndex = 0;
                    updateRadarTimestamp();
                }

                state.radarInterval = setInterval(() => {
                    state.radarLayers[state.currentRadarIndex].setOpacity(0);
                    state.currentRadarIndex = (state.currentRadarIndex + 1) % state.radarLayers.length;
                    state.radarLayers[state.currentRadarIndex].setOpacity(0.7);
                    updateRadarTimestamp();
                }, 500);

            } catch (err) {
                console.error('Radar error:', err);
                document.getElementById('radar-timestamp').textContent = 'Radar unavailable';
            }
        }

        renderRecentZips();
        loadWeather();
    </script>
</body>
</html>
